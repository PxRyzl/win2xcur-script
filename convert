#! /bin/bash

# test-cursor directory
mkdir -p $HOME/win2xcur-script/test-cursor/cursors
touch $HOME/win2xcur-script/test-cursor/index.theme

# Create the .converting directory
base_dir=$HOME/win2xcur-script/.converting
dirs=(
  Alternate Busy Cross Default Dgn1
  Dgn2 Hand Help Horizontal Link
  Move Text Unavailable Vertical Work
)

for name in "${dirs[@]}"; do
  mkdir -p "$base_dir/${name}-d"
done

# Create file for inside test-cursor
cat <<EOF >> $HOME/win2xcur-script/test-cursor/index.theme
[Icon Theme]
Name=test-cursor
Comment=this is for testing
EOF

# Convert the cursor into xcursor
#!/bin/bash

BASE_DIR="$HOME/win2xcur-script"
INPUT_DIR="$BASE_DIR/input"
CONVERTING_DIR="$BASE_DIR/.converting"
PROCESS_DIR="$BASE_DIR/.process"

# Determine which win2xcur to use
if command -v win2xcur >/dev/null 2>&1; then
    WIN2XCUR="win2xcur"
    echo "🛠️ Using system-installed win2xcur"
elif [ -x "$BASE_DIR/win2xcur" ]; then
    WIN2XCUR="$BASE_DIR/win2xcur"
    echo "🛠️ Using local win2xcur from $WIN2XCUR"
else
    echo "❌ win2xcur not found in system or $BASE_DIR."
    echo "Please install win2xcur or place it in $BASE_DIR"
    exit 1
fi

convert_cursor_set() {
    local name="$1"
    local input_path="$INPUT_DIR/$name"
    local output_path="$CONVERTING_DIR/${name}-d"
    local final_path="$PROCESS_DIR/$name"

    # Replace spaces with dashes in filenames
    for file in "$input_path"/*; do
        mv -- "$file" "${file// /-}" 2>/dev/null
    done

    # Process .ani and .cur files
    for file in "$input_path"/*; do
        ext="${file##*.}"

        if [[ $ext == ani || $ext == cur ]]; then
            # Use the detected win2xcur binary
            "$WIN2XCUR" "$file" -o "$output_path"

            # Move converted files to final path
            for converted_file in "$output_path"/*; do
                mv "$converted_file" "$final_path"
            done
        fi
    done
}

# List of cursor categories
cursor_sets=(
    Alternate Busy Dgn1 Dgn2 Hand Help Horizontal Link Move
    Default Cross Text Unavailable Vertical Work
)

# Run conversion for each set
for set in "${cursor_sets[@]}"; do
    convert_cursor_set "$set"
done


# Copy into the test-cursor file
src_base=$HOME/win2xcur-script/.process
dest_base=$HOME/win2xcur-script/test-cursor/cursors

declare -A mappings=(
  [Alternate]="bottom_left_corner bottom_right_corner bottom_side down-arrow left-arrow left_side right-arrow right_side top_left_corner top_right_corner top_side up_arrow"
  [Busy]="half-busy wait watch"
  [Cross]="cross crosshair"
  [Default]="arrow default left_ptr size-bdiag size-fdiag size-hor size-ver top_left_arrow"
  [Dgn1]="nw-resize nwse-resize se-resize size_fdiag"
  [Dgn2]="ne-resize nesw-resize sw-resize size_bdiag"
  [Hand]="draft pencil"
  [Help]="help left_ptr_help question_arrow whats_this"
  [Horizontal]="col-resize e-resize ew-resize h_double_arrow sb_h_double_arrow size_hor split_h w-resize"
  [Link]="grab hand hand1 hand2 openhand pointer pointing_hand"
  [Move]="all-scroll closedhand dnd-move dnd-none fleur grabbing move size_all"
  [Text]="ibeam text xterm"
  [Unavailable]="circle crossed_circle dnd_no_drop forbidden no_drop not_allowed"
  [Vertical]="n-resize ns-resize row-resize s-resize sb_v_double_arrow size_ver split_v v_double_arrow"
  [Work]="left_ptr_watch pirate progress"
)

for category in "${!mappings[@]}"; do
  src="$src_base/$category"
  for cursor in ${mappings[$category]}; do
    cp "$src" "$dest_base/$cursor"
  done
done

# Remove file
rm $HOME/win2xcur-script/.process/*

input_dirs=(
  Alternate Busy Cross Default Dgn1 Dgn2 Hand Help
  Horizontal Link Move Text Unavailable Vertical Work .trash
)

for dir in "${input_dirs[@]}"; do
  rm -f $HOME/win2xcur-script/input/$dir/*
done

rm -rf $HOME/win2xcur-script/.converting/* $HOME/win2xcur-script/.process/*
rm $HOME/win2xcur-script/cursor-input/*
